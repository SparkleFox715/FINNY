<!DOCTYPE html>
<html lang="en">
<script type="text/javascript" src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <h1 class="bubbly">Financial Data</h1>
        <p>Enter a stock ticker to view financial data:</p>
        <input type="text" id="ticker" placeholder="Enter stock ticker">
        <button onclick="fetchFinanceData()">Get Finance Data</button>
        <div id="financeDataDisplay" class="dataSection"></div>
        <div id="chartContainer" style="height: 300px; width: 100%;">
    </div>

    <script>
        async function fetchFinanceData() {
            const ticker = document.getElementById('ticker').value;
            const response = await fetch('/fetch-finance-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ticker: ticker })
            });
            const financeDataDisplay = document.getElementById('financeDataDisplay');
            if (response.ok) {
                const data = await response.json();
                createChart(ticker, data[1], data[2], data[3], data[4], data[5], data[6], data[7], data[8], data[9], data[10], data[11], data[12], data[13], data[14], data[15], data[16], data[17], data[18], data[19], data[20])
                //financeDataDisplay.innerHTML = '<pre>' + JSON.stringify(data[1], null, 2) + '</pre>';
            } else {
                const error = await response.json();
                financeDataDisplay.textContent = `Error: ${error.error}`;
            }
        }
        function createChart(symbol, W1_open, W1_low, W1_high, W1_closing, M1_open, M1_low, M1_high, M1_closing, M3_open, M3_low, M3_high, M3_closing, M6_open, M6_low, M6_high, M6_closing, Y1_open, Y1_low, Y1_high, Y1_closing){
            //W1 chart
            key = Object.keys(W1_open);
            let W1datPonC = [];
            var len =  key.length;
            for(let i =0;i<len;i++){
                var temp = {x: new Date(key[i]), y:[W1_open[key[i]], W1_high[key[i]],W1_low[key[i]],W1_closing[key[i]]]};
                W1datPonC.push(temp);
            }

            let W1datPonL = [];
            for(let i =0;i<len;i++){
                var temp = {x: new Date(key[i]), y:W1_closing[key[i]]};
                W1datPonL.push(temp);
            }
            
           // generateChart(symbol+" for 1 Week", W1datPonC, "day", "1", "DD-MMM-YY", true);
            generateChart(symbol+" for 1 Week", W1datPonL, "day", "1", "DD-MMM-YY", false);
            //M1 chart
            //M3 chart
            //M6 chart
            //Y1 chart
        }

        function generateChart(title, datPon, interType, inter, formatting, charting){
            //true for line will result in candle chart, false will result in line chart
            font = "tahoma";

            if(charting){
                var chart = new CanvasJS.Chart("chartContainer",
                {
                    
                    backgroundColor: "#000000",
                    title:{
                        fontColor: "white",
                        text: title,
                        fontFamily: font
                    },
                    zoomEnabled: true, 
                    exportEnabled: false,
                    axisY: {
                        includeZero:false,
                        title: "Prices",
                        prefix: "$ ",
                        tickColor: "white",
                        gridColor:"#4F4F4F",
                        lineColor:"white",
                        titleFontColor: "white",
                        labelFontColor: "white",
                        crosshair: { 
                            enabled: true,
                            color:"#4F4F4F"
                        } 
                    },
                    axisX: {
                        labelFontColor: "white",
                        interval:inter,
                        intervalType: interType,
                        valueFormatString: formatting,
                        labelAngle: -45,
                        tickColor:"white",
                        lineColor:"white",
                        crosshair: { 
                            enabled: true,
                            color:"#4F4F4F"
                        } 
                    },
                    data: [
                    {
                        type: "candlestick",
                        color: "white",
                        risingColor: "green",
                        fallingColor:"red",
                        dataPoints: datPon
                    }
                    ]
                });
                chart.render();
            }else{
                var chart = new CanvasJS.Chart("chartContainer",
                {
                    backgroundColor: "#000000",
                    title:{
                        fontColor: "white",
                        text: title,
                        fontFamily: font
                    },
                    zoomEnabled: true,
                    exportEnabled: false,
                    axisY: {
                        
                        includeZero:false,
                        title: "Prices",
                        prefix: "$ ",
                        tickColor: "white",
                        gridColor:"#4F4F4F",
                        lineColor:"white",
                        titleFontColor: "white",
                        labelFontColor: "white",
                        crosshair: { 
                            enabled: true,
                            color:"#4F4F4F"
                        } 
                    },
                    axisX: {
                        labelFontColor: "white",
                        labelAngle: -45,
                        tickColor:"white",
                        lineColor:"white",
                        crosshair: { 
                            enabled: true,
                            color:"#4F4F4F"
                        } 
                    },
                    data: [
                    {
                        type: "line",
                        dataPoints: datPon
                    }
                    ]
                });
                chart.render();
            }
            
        }
    </script>
</body>
</html>

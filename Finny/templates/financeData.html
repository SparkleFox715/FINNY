<!DOCTYPE html>
<html lang="en">
<script type="text/javascript" src="https://cdn.canvasjs.com/canvasjs.min.js"></script>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Data</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <div class="container">
        <div id ="headings">
            <h1 class="bubbly">Financial Data</h1>
            <p>Enter a stock ticker to view financial data:</p>
            <input type="text" id="ticker" placeholder="Enter stock ticker">
            <button onclick="fetchFinanceData(1, 1)">Get Finance Data</button>
        </div>

        <div id="financeDataDisplay" class="dataSection"></div>

        <button hidden class = "butt" id="lineGraph" onclick="fetchFinanceData(1, -1)">Line</button>
        <button hidden class = "butt" id="candleGraph" onclick="fetchFinanceData(2, -1)">Candle</button>
        <button hidden class = "butt" id="Week1" onclick="fetchFinanceData(-1, 1)">1 Week</button>
        <button hidden class = "butt" id="Month1" onclick="fetchFinanceData(-1, 2)">1 Month</button>
        <button hidden class = "butt" id="Month3" onclick="fetchFinanceData(-1, 3)">3 Months</button>
        <button hidden class = "butt" id="Month6" onclick="fetchFinanceData(-1, 4)">6 Months</button>
        <button hidden class = "butt" id="Year1" onclick="fetchFinanceData(-1, 5)">1 Year</button>


        <div id="chartContainer" style="height: 65%; width: 60%; position:absolute;"></div>

        <table hidden id="datTable">
            <tr>
                <td id = "T1row1V1">a</td>
                <td id = "T1row1V2">b</td>
            </tr>
            <tr>
                <td id = "T1row2V1">a</td>
                <td id = "T1row2V2">b</td>
            </tr>
            <tr>
                <td id = "T1row3V1">a</td>
                <td id = "T1row3V2">b</td>
            </tr>
        </table>
              
    

    <script>
        var GChoice = 1;
        var TChoice = 1;
        async function fetchFinanceData(GraphChoice, TimeChoice) {
            if(GraphChoice!=-1){GChoice = GraphChoice;}
            if(TimeChoice!=-1){TChoice = TimeChoice;}

            const ticker = document.getElementById('ticker').value;
            const response = await fetch('/fetch-finance-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ ticker: ticker })
            });
            const financeDataDisplay = document.getElementById('financeDataDisplay');
            if (response.ok) {
                var heading = document.getElementById("headings");
                heading.style.position ="absolute";
                heading.style.top="0%";
                heading.style.left="37%";

                var graphs = document.getElementById("chartContainer");
                graphs.style.position = "absolute";
                graphs.style.top = "35%";
                graphs.style.left="2%";

                var b1 = document.getElementById("lineGraph");
                var b2 = document.getElementById("candleGraph");
                var b3 = document.getElementById("Week1");
                var b4 = document.getElementById("Month1");
                var b5 = document.getElementById("Month3");
                var b6 = document.getElementById("Month6");
                var b7 = document.getElementById("Year1");
                b1.removeAttribute("hidden")
                b2.removeAttribute("hidden")
                b3.removeAttribute("hidden")
                b4.removeAttribute("hidden")
                b5.removeAttribute("hidden")
                b6.removeAttribute("hidden")
                b7.removeAttribute("hidden")
                b1.style.position ="absolute";
                b2.style.position ="absolute";
                b3.style.position ="absolute";
                b4.style.position ="absolute";
                b5.style.position ="absolute";
                b6.style.position ="absolute";
                b7.style.position ="absolute";
                var topPos ="29%";
                b1.style.top=topPos;
                b2.style.top=topPos;
                b3.style.top=topPos;
                b4.style.top=topPos;
                b5.style.top=topPos;
                b6.style.top=topPos;
                b7.style.top=topPos;
                b1.style.left = "2%";
                b2.style.left = "6%";
                b3.style.left = "34%";
                b4.style.left = "39%";
                b5.style.left = "44%";
                b6.style.left = "50%";
                b7.style.left = "56%";

                var tabling = document.getElementById("datTable");
                tabling.removeAttribute("hidden");
                tabling.style.position ="absolute";
                tabling.style.right="2%";

                const data = await response.json();
                createChart(ticker, data[1], data[2], data[3], data[4], data[5], data[6], data[7], data[8], data[9], data[10], data[11], data[12], data[13], data[14], data[15], data[16], data[17], data[18], data[19], data[20])
                //financeDataDisplay.innerHTML = '<pre>' + JSON.stringify(data[1], null, 2) + '</pre>';
            } else {
                const error = await response.json();
                financeDataDisplay.textContent = `Error: ${error.error}`;
            }
        }
        function createChart(symbol, W1_open, W1_low, W1_high, W1_closing, M1_open, M1_low, M1_high, M1_closing, M3_open, M3_low, M3_high, M3_closing, M6_open, M6_low, M6_high, M6_closing, Y1_open, Y1_low, Y1_high, Y1_closing){
            //W1 chart
            var title  = symbol;
            var dat1;
            var dat2;
            var dat3;
            var dat4;
            var xAxis="";
            var format="";
            var graphs=false;

            if(TChoice == 1){
                dat1 =W1_open;
                dat2 =W1_low;
                dat3=W1_high;
                dat4 =W1_closing;
                title = title+" for 1 Week";
                xAxis = "day";
                format = "DD-MMM-YY";
            }else if(TChoice ==2){
                dat1 =M1_open;
                dat2 =M1_low;
                dat3=M1_high;
                dat4 =M1_closing;
                title = title+" for 1 Month";
                xAxis = "week";
                format = "MMM-YY";
            }else if(TChoice ==3){
                dat1 =M3_open;
                dat2 =M3_low;
                dat3=M3_high;
                dat4 =M3_closing;
                title = title+" for 3 Months";
                xAxis = "week";
                format = "MMM-YY";
            }else if(TChoice ==4){
                dat1 =M6_open;
                dat2 =M6_low;
                dat3=M6_high;
                dat4 =M6_closing;
                title = title+" for 6 Months";
                xAxis = "week";
                format = "MMM-YY";
            }else if(TChoice ==5){
                dat1 =Y1_open;
                dat2 =Y1_low;
                dat3=Y1_high;
                dat4 =Y1_closing;
                title = title +" for 1 Year";
                xAxis = "month";
                format = "MMM";
            }

            key = Object.keys(dat1);
            var len =  key.length;
            let DatPonC = [];
            let DatPonL = [];
            for(let i =0;i<len;i++){
                var temp = {x: new Date(key[i]), y:[dat1[key[i]], dat2[key[i]],dat3[key[i]],dat4[key[i]]]};
                DatPonC.push(temp);
            }
            console.log(DatPonC);
            for(let i =0;i<len;i++){
                var temp = {x: new Date(key[i]), y:dat4[key[i]]};
                DatPonL.push(temp);
            }
            console.log(DatPonL);

            if(GChoice==1){
                generateChart(title, DatPonL, xAxis, "1", format, false);
            }else if (GChoice==2){
                generateChart(title, DatPonC, xAxis, "1", format, true);
            }
           
            
           
            //M1 chart
            //M3 chart
            //M6 chart
            //Y1 chart
        }

        function generateChart(title, datPon, interType, inter, formatting, charting){
            //true for line will result in candle chart, false will result in line chart
            font = "tahoma";

            if(charting){   
                var chart = new CanvasJS.Chart("chartContainer",
                {
                    backgroundColor: "#000000",
                    title:{
                        fontColor: "white",
                        text: title,
                        fontFamily: font
                    },
                    zoomEnabled: true, 
                    exportEnabled: false,
                    axisY: {
                        includeZero:false,
                        title: "Prices",
                        prefix: "$ ",
                        tickColor: "white",
                        gridColor:"#4F4F4F",
                        lineColor:"white",
                        titleFontColor: "white",
                        labelFontColor: "white",
                        crosshair: { 
                            enabled: true,
                            color:"#4F4F4F"
                        } 
                    },
                    axisX: {
                        labelFontColor: "white",
                        interval:inter,
                        intervalType: interType,
                        valueFormatString: formatting,
                        labelAngle: -45,
                        tickColor:"white",
                        lineColor:"white",
                        crosshair: { 
                            enabled: true,
                            color:"#4F4F4F"
                        } 
                    },
                    data: [
                    {
                        type: "candlestick",
                        color: "white",
                        risingColor: "green",
                        fallingColor:"red",
                        dataPoints: datPon
                    }
                    ]
                });
                chart.render();
            }else{
                var chart = new CanvasJS.Chart("chartContainer",
                {
                   
                    backgroundColor: "#000000",
                    title:{
                        fontColor: "white",
                        text: title,
                        fontFamily: font
                    },
                    zoomEnabled: true,
                    exportEnabled: false,
                    axisY: {
                        
                        includeZero:false,
                        title: "Prices",
                        prefix: "$ ",
                        tickColor: "white",
                        gridColor:"#4F4F4F",
                        lineColor:"white",
                        titleFontColor: "white",
                        labelFontColor: "white",
                        crosshair: { 
                            enabled: true,
                            color:"#4F4F4F"
                        } 
                    },
                    axisX: {
                        labelFontColor: "white",
                        labelAngle: -45,
                        tickColor:"white",
                        lineColor:"white",
                        crosshair: { 
                            enabled: true,
                            color:"#4F4F4F"
                        } 
                    },
                    data: [
                    {
                        type: "line",
                        dataPoints: datPon
                    }
                    ]
                });
                chart.render();
            }
            
        }
    </script>
</body>
</html>
